<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: packages/ArchiveFormatVersion1.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: packages/ArchiveFormatVersion1.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var fs = require('fs');
var path = require('path');
var util = require('util');

var async = require('async');
var xml2js = require('xml2js');

var ArchiveFormat = process.requirePublish('app/server/packages/ArchiveFormat.js');

/**
 * @module publish/packages/ArchiveFormatVersion1
 */

/**
 * Defines an ArchiveFormatVersion1 to manage the content of an archive in version 1 format.
 *
 * An ArchiveFormatVersion1 must contain:
 *  - A video file
 *  - A .session file containing archive metadatas
 *
 * An ArchiveFormatVersion1 may contain:
 *  - A list of file images referenced in .session file
 *  - A synchro.xml file (deprecated) referencing the list of file images if not referenced in .session file
 *
 * @class ArchiveFormatVersion1
 * @extends module:publish/packages/ArchiveFormat~ArchiveFormat
 * @constructor
 * @param {String} mediaPackagePath The directory where to find extracted files of the archive
 */
function ArchiveFormatVersion1(mediaPackagePath) {
  ArchiveFormatVersion1.super_.call(this, mediaPackagePath, '.session', 'date', 'name');
}

module.exports = ArchiveFormatVersion1;
util.inherits(ArchiveFormatVersion1, ArchiveFormat);

/**
 * Gets points of interest from the given XML file.
 *
 * This will check if the file exists first.
 *
 * 1. Test if XML file exists
 * 2. Transcode XML file to a JSON equivalent
 *
 * @example
 * // Transform XML points of interest into JSON
 * // From:
 * &lt;player>
 *   &lt;synchro id="slide_00000.jpeg" timecode="0"/>
 *   &lt;synchro id="slide_00001.jpeg" timecode="1200"/>
 * &lt;/player>
 *
 * // To:
 * [
 *   {
 *     "timecode": 0,
 *     "type": "image"
 *     "data": {
 *       "filename": "slide_00000.jpeg"
 *     }
 *   },
 *   {
 *     "timecode": 1200,
 *     "type": "image"
 *     "data": {
 *       "filename": "slide_00001.jpeg"
 *     }
 *   }
 * ]
 *
 * @memberof module:publish/packages/ArchiveFormatVersion1~ArchiveFormatVersion1
 * @this module:publish/packages/ArchiveFormatVersion1~ArchiveFormatVersion1
 * @private
 * @param {String} xmlFilePath The path of the XML file containing points of interest
 * @param
 * {module:publish/packages/ArchiveFormatVersion1~ArchiveFormatVersion1~getImagesPointsOfInterestFromXmlFileCallback}
 * callback The function to call when it's done
 */
function getImagesPointsOfInterestFromXmlFile(xmlFilePath, callback) {
  var formattedPointsOfInterest = [];

  fs.readFile(xmlFilePath, function(error, data) {
    if (error) return callback(error);

    xml2js.parseString(data, {mergeAttrs: true}, function(error, pointsOfInterest) {
      if (pointsOfInterest &amp;&amp; pointsOfInterest.player &amp;&amp; pointsOfInterest.player.synchro) {

        // Iterate through the list of points of interest
        // Change JSON organization to be more accessible
        pointsOfInterest.player.synchro.forEach(function(pointOfInterestInfo) {
          if (pointOfInterestInfo['id'] &amp;&amp; pointOfInterestInfo['id'].length) {
            formattedPointsOfInterest.push({
              timecode: parseInt(pointOfInterestInfo['timecode'][0]),
              type: 'image',
              data: {
                filename: pointOfInterestInfo['id'][0]
              }
            });
          }
        });
      }
      callback(error, formattedPointsOfInterest);
    });
  });
}

/**
 * Gets medias file names from metadatas.
 *
 * @return {module:publish/packages/ArchiveFormat~ArchiveFormat~getMediasCallback} Function to call when its done
 */
ArchiveFormatVersion1.prototype.getMedias = function(callback) {
  this.getProperty('filename', function(error, fileName) {
    if (error) return callback(error);
    callback(null, [fileName]);
  });
};

/**
 * Gets points of interest.
 *
 * @return {module:publish/packages/ArchiveFormat~ArchiveFormat~getPointsOfInterestCallback} Function to call when its
 * done
 */
ArchiveFormatVersion1.prototype.getPointsOfInterest = function(callback) {
  var pointsOfInterest = [];
  var self = this;

  async.series([

    // Get points of interest from metadatas
    function(callback) {
      self.getProperty('indexes', function(error, indexes) {
        if (error) return callback(error);
        pointsOfInterest = (indexes || []).map(function(index) {
          var pointOfInterest = {
            type: index.type,
            timecode: index.timecode,
            data: {}
          };

          if (index.data) {
            if (index.type === 'image') {
              pointOfInterest.data = {
                filename: index.data.filename
              };
            } else if (index.type === 'tag') {
              pointOfInterest.data = {
                category: index.data.category,
                description: index.data.text,
                name: index.data.tagname
              };
            }
          }
          return pointOfInterest;
        });
        callback();
      });
    },

    // Points of interest can also be found in metadatas file, try to get them from deprecated synchro.xml file
    function(callback) {
      var xmlFilePath = path.join(self.mediaPackagePath, 'synchro.xml');

      fs.access(xmlFilePath, function(error) {
        if (error) return callback();

        getImagesPointsOfInterestFromXmlFile.call(self, xmlFilePath, function(error, pointsOfInterestFromXml) {
          if (error) return callback(error);

          pointsOfInterest = pointsOfInterest.concat(pointsOfInterestFromXml);
          callback();
        });
      });
    }

  ], function(error) {
    if (error) return callback(error);
    callback(null, pointsOfInterest);
  });
};

/**
 * Validates the archive.
 *
 * The archive should contain video file referenced in metadatas file.
 *
 * @return {module:publish/packages/ArchiveFormat~ArchiveFormat~validateCallback} Function to call when its done
 */
ArchiveFormatVersion1.prototype.validate = function(callback) {
  var self = this;

  this.getProperty('filename', function(error, mediaFileName) {
    if (error) return callback(error);
    if (!mediaFileName) {
      process.logger.debug(
        'Missing "filename" property in metadatas file of archive version 1 format'
      );
      return callback(null, false);
    }

    // Got the name of the video file
    // Test if video file really exists in package
    fs.access(path.join(self.mediaPackagePath, mediaFileName), function(error) {
      if (error) {
        process.logger.debug('Missing file ' + mediaFileName + ' into archive version 1 format');
        return callback(null, false);
      }

      callback(null, true);
    });
  });
};

/**
 * @callback
 * module:publish/packages/ArchiveFormatVersion1~ArchiveFormatVersion1~getImagesPointsOfInterestFromXmlFileCallback
 * @param {(Error|undefined)} error The error if an error occurred
 * @param {Array} pointsOfInterest The list of points of interest of type image
 * @param {Number} pointsOfInterest[].timecode Point of interest timecode
 * @param {String} pointsOfInterest[].type Point of interest type (alway "image")
 * @param {Object} pointsOfInterest[].data Point of interest data
 * @param {String} pointsOfInterest[].data.filename Point of interest image file path in the archive
 */
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-publish_controllers_ConfigurationController.html">publish/controllers/ConfigurationController</a></li><li><a href="module-publish_controllers_httpErrors.html">publish/controllers/httpErrors</a></li><li><a href="module-publish_controllers_PropertyController.html">publish/controllers/PropertyController</a></li><li><a href="module-publish_controllers_StatisticsController.html">publish/controllers/StatisticsController</a></li><li><a href="module-publish_controllers_VideoController.html">publish/controllers/VideoController</a></li><li><a href="module-publish_hooks.html">publish/hooks</a></li><li><a href="module-publish_listener.html">publish/listener</a></li><li><a href="module-publish_packages_ArchiveFormat.html">publish/packages/ArchiveFormat</a></li><li><a href="module-publish_packages_archiveFormatFactory.html">publish/packages/archiveFormatFactory</a></li><li><a href="module-publish_packages_ArchiveFormatVersion1.html">publish/packages/ArchiveFormatVersion1</a></li><li><a href="module-publish_packages_ArchiveFormatVersion2.html">publish/packages/ArchiveFormatVersion2</a></li><li><a href="module-publish_packages_ArchivePackage.html">publish/packages/ArchivePackage</a></li><li><a href="module-publish_packages_ArchivePackageError.html">publish/packages/ArchivePackageError</a></li><li><a href="module-publish_packages_errors.html">publish/packages/errors</a></li><li><a href="module-publish_packages_Package.html">publish/packages/Package</a></li><li><a href="module-publish_packages_PackageError.html">publish/packages/PackageError</a></li><li><a href="module-publish_packages_packageFactory.html">publish/packages/packageFactory</a></li><li><a href="module-publish_packages_states.html">publish/packages/states</a></li><li><a href="module-publish_packages_VideoPackageError.html">publish/packages/VideoPackageError</a></li><li><a href="module-publish_providers_mediaPlatforms_factory.html">publish/providers/mediaPlatforms/factory</a></li><li><a href="module-publish_providers_mediaPlatforms_LocalProvider.html">publish/providers/mediaPlatforms/LocalProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_MediaPlatformProvider.html">publish/providers/mediaPlatforms/MediaPlatformProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_tls_TlsClient.html">publish/providers/mediaPlatforms/tls/TlsClient</a></li><li><a href="module-publish_providers_mediaPlatforms_tls_TlsProvider.html">publish/providers/mediaPlatforms/tls/TlsProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_types.html">publish/providers/mediaPlatforms/types</a></li><li><a href="module-publish_providers_mediaPlatforms_VimeoProvider.html">publish/providers/mediaPlatforms/VimeoProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_WowzaProvider.html">publish/providers/mediaPlatforms/WowzaProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_GoogleOAuthHelper.html">publish/providers/mediaPlatforms/youtube/GoogleOAuthHelper</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_YoutubeProvider.html">publish/providers/mediaPlatforms/youtube/YoutubeProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_YoutubeResumableUpload.html">publish/providers/mediaPlatforms/youtube/YoutubeResumableUpload</a></li><li><a href="module-publish_providers_PoiProvider.html">publish/providers/PoiProvider</a></li><li><a href="module-publish_providers_PropertyProvider.html">publish/providers/PropertyProvider</a></li><li><a href="module-publish_providers_VideoPackage.html">publish/providers/VideoPackage</a></li><li><a href="module-publish_providers_VideoProvider.html">publish/providers/VideoProvider</a></li><li><a href="module-publish_PublishError.html">publish/PublishError</a></li><li><a href="module-publish_PublishManager.html">publish/PublishManager</a></li><li><a href="module-publish_PublishPlugin.html">publish/PublishPlugin</a></li><li><a href="module-publish_PublishPluginApi.html">publish/PublishPluginApi</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-publish_controllers_httpErrors-HTTP_ERRORS.html">publish/controllers/httpErrors~HTTP_ERRORS</a></li><li><a href="module-publish_hooks-PUBLISH_HOOKS.html">publish/hooks~PUBLISH_HOOKS</a></li><li><a href="module-publish_packages_errors-ERRORS.html">publish/packages/errors~ERRORS</a></li><li><a href="module-publish_packages_states-STATES.html">publish/packages/states~STATES</a></li><li><a href="module-publish_providers_mediaPlatforms_types-TYPES.html">publish/providers/mediaPlatforms/types~TYPES</a></li></ul><h3>Classes</h3><ul><li><a href="module-publish_controllers_ConfigurationController-ConfigurationController.html">publish/controllers/ConfigurationController~ConfigurationController</a></li><li><a href="module-publish_controllers_PropertyController-PropertyController.html">publish/controllers/PropertyController~PropertyController</a></li><li><a href="module-publish_controllers_StatisticsController-StatisticsController.html">publish/controllers/StatisticsController~StatisticsController</a></li><li><a href="module-publish_controllers_VideoController-VideoController.html">publish/controllers/VideoController~VideoController</a></li><li><a href="module-publish_packages_ArchiveFormatVersion1-ArchiveFormatVersion1.html">publish/packages/ArchiveFormatVersion1~ArchiveFormatVersion1</a></li><li><a href="module-publish_packages_ArchiveFormatVersion2-ArchiveFormatVersion2.html">publish/packages/ArchiveFormatVersion2~ArchiveFormatVersion2</a></li><li><a href="module-publish_packages_ArchiveFormat-ArchiveFormat.html">publish/packages/ArchiveFormat~ArchiveFormat</a></li><li><a href="module-publish_packages_ArchivePackageError-ArchivePackageError.html">publish/packages/ArchivePackageError~ArchivePackageError</a></li><li><a href="module-publish_packages_ArchivePackage-ArchivePackage.html">publish/packages/ArchivePackage~ArchivePackage</a></li><li><a href="module-publish_packages_PackageError-PackageError.html">publish/packages/PackageError~PackageError</a></li><li><a href="module-publish_packages_Package-Package.html">publish/packages/Package~Package</a></li><li><a href="module-publish_packages_VideoPackageError-VideoPackageError.html">publish/packages/VideoPackageError~VideoPackageError</a></li><li><a href="module-publish_providers_mediaPlatforms_LocalProvider-LocalProvider.html">publish/providers/mediaPlatforms/LocalProvider~LocalProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_MediaPlatformProvider-MediaPlatformProvider.html">publish/providers/mediaPlatforms/MediaPlatformProvider~MediaPlatformProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_tls_TlsClient-TlsClient.html">publish/providers/mediaPlatforms/tls/TlsClient~TlsClient</a></li><li><a href="module-publish_providers_mediaPlatforms_tls_TlsProvider-TlsProvider.html">publish/providers/mediaPlatforms/tls/TlsProvider~TlsProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_VimeoProvider-VimeoProvider.html">publish/providers/mediaPlatforms/VimeoProvider~VimeoProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_WowzaProvider-WowzaProvider.html">publish/providers/mediaPlatforms/WowzaProvider~WowzaProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_GoogleOAuthHelper-GoogleOAuthHelper.html">publish/providers/mediaPlatforms/youtube/GoogleOAuthHelper~GoogleOAuthHelper</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_YoutubeProvider-YoutubeProvider.html">publish/providers/mediaPlatforms/youtube/YoutubeProvider~YoutubeProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_YoutubeResumableUpload-ResumableUpload.html">publish/providers/mediaPlatforms/youtube/YoutubeResumableUpload~ResumableUpload</a></li><li><a href="module-publish_providers_PoiProvider-PoiProvider.html">publish/providers/PoiProvider~PoiProvider</a></li><li><a href="module-publish_providers_PropertyProvider-PropertyProvider.html">publish/providers/PropertyProvider~PropertyProvider</a></li><li><a href="module-publish_providers_VideoPackage-VideoPackage.html">publish/providers/VideoPackage~VideoPackage</a></li><li><a href="module-publish_providers_VideoProvider-VideoProvider.html">publish/providers/VideoProvider~VideoProvider</a></li><li><a href="module-publish_PublishError-PublishError.html">publish/PublishError~PublishError</a></li><li><a href="module-publish_PublishManager-PublishManager.html">publish/PublishManager~PublishManager</a></li><li><a href="module-publish_PublishPluginApi-PublishPluginApi.html">publish/PublishPluginApi~PublishPluginApi</a></li><li><a href="module-publish_PublishPlugin-PublishPlugin.html">publish/PublishPlugin~PublishPlugin</a></li></ul><h3>Events</h3><ul><li><a href="module-publish_packages_ArchivePackage-ArchivePackage.html#event:complete">publish/packages/ArchivePackage~ArchivePackage#complete</a></li><li><a href="module-publish_packages_ArchivePackage-ArchivePackage.html#event:error">publish/packages/ArchivePackage~ArchivePackage#error</a></li><li><a href="module-publish_packages_ArchivePackage-ArchivePackage.html#event:stateChanged">publish/packages/ArchivePackage~ArchivePackage#stateChanged</a></li><li><a href="module-publish_packages_Package-Package.html#event:complete">publish/packages/Package~Package#complete</a></li><li><a href="module-publish_packages_Package-Package.html#event:error">publish/packages/Package~Package#error</a></li><li><a href="module-publish_packages_Package-Package.html#event:stateChanged">publish/packages/Package~Package#stateChanged</a></li><li><a href="module-publish_providers_VideoPackage-VideoPackage.html#event:complete">publish/providers/VideoPackage~VideoPackage#complete</a></li><li><a href="module-publish_providers_VideoPackage-VideoPackage.html#event:error">publish/providers/VideoPackage~VideoPackage#error</a></li><li><a href="module-publish_providers_VideoPackage-VideoPackage.html#event:stateChanged">publish/providers/VideoPackage~VideoPackage#stateChanged</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:complete">publish/PublishManager~PublishManager#complete</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:error">publish/PublishManager~PublishManager#error</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:retry">publish/PublishManager~PublishManager#retry</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:stateChanged">publish/PublishManager~PublishManager#stateChanged</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:upload">publish/PublishManager~PublishManager#upload</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Tue Apr 19 2022 09:48:29 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
