<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: providers/mediaPlatforms/tls/TlsProvider.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: providers/mediaPlatforms/tls/TlsProvider.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * @module publish/providers/mediaPlatforms/tls/TlsProvider
 */

var path = require('path');
var util = require('util');
var nanoid = require('nanoid').nanoid;
var async = require('async');
var openVeoApi = require('@openveo/api');
var MediaPlatformProvider = process.requirePublish('app/server/providers/mediaPlatforms/MediaPlatformProvider.js');
var PropertyProvider = process.requirePublish('app/server/providers/PropertyProvider.js');
var TlsClient = process.requirePublish('app/server/providers/mediaPlatforms/tls/TlsClient.js');
var ResourceFilter = openVeoApi.storages.ResourceFilter;

/**
 * Defines a TlsProvider to interact with TLS platform.
 *
 * @class TlsProvider
 * @extends module:publish/providers/mediaPlatforms/MediaPlatformProvider~MediaPlatformProvider
 * @constructor
 * @param {Object} providerConf TLS configuration
 * @param {String} providerConf.nfsPath The absolute path of the NFS directory shared with TLS
 * @param {String} providerConf.mediaDirectoryPath The path of the directory where to store TLS medias. This is
 * relative to nfsPath
 * @param {String} providerConf.accessToken The TLS API authentication token
 * @param {String} providerConf.url The TLS web service URL
 * @param {String} [providerConf.certificate] The absolute path of the full certificate chain if the top level
 * authority is not part of system well known authorities
 */
function TlsProvider(providerConf) {
  TlsProvider.super_.call(this, providerConf);

  if (!providerConf.nfsPath || typeof providerConf.nfsPath !== 'string')
    throw new TypeError('Invalid NFS path: ' + providerConf.nfsPath);

  Object.defineProperties(this,

    /** @lends module:publish/providers/mediaPlatforms/tls/TlsProvider~TlsProvider */
    {

      /**
       * The TLS client to interact with TLS web service.
       *
       * @type {module:publish/providers/mediaPlatforms/tls/TlsClient~TlsClient}
       * @instance
       * @readonly
       */
      client: {
        value: new TlsClient(providerConf.url, providerConf.accessToken, providerConf.certificate)
      },

      /**
       * The absolute path to the directory containing medias.
       *
       * @type {String}
       * @instance
       * @readonly
       */
      mediaDirectoryPath: {
        value: path.join(providerConf.nfsPath, providerConf.mediaDirectoryPath || '')
      }

    }

  );
}

module.exports = TlsProvider;
util.inherits(TlsProvider, MediaPlatformProvider);

/**
 * Uploads a media to the TLS platform.
 *
 * Media is uploaded on a local directory as OpenVeo and TLS share a common directory through NFS.
 *
 * @param {String} mediaFilePath The absolute path of the media to upload
 * @param {module:publish/providers/mediaPlatforms/MediaPlatformProvider~MediaPlatformProvider~uploadCallback} callback
 * The function to call when it's done
 */
TlsProvider.prototype.upload = function(mediaFilePath, callback) {
  var self = this;
  var mediaId = nanoid();
  var mediaFileName = 'video.mp4';
  var mediaFinalPath = path.join(this.mediaDirectoryPath, mediaId, mediaFileName);

  // Create media directory and copy media file to its final directory
  openVeoApi.fileSystem.copy(mediaFilePath, mediaFinalPath, function(error) {
    if (error) return callback(error);

    // Send media information to TLS
    self.client.put('videos/' + mediaId, {
      path: path.join(self.conf.mediaDirectoryPath, mediaId, mediaFileName)
    }).then(function(response) {
      callback(null, mediaId);
    }).catch(function(error) {

      // Something went wrong, remove the media directory
      openVeoApi.fileSystem.rm(path.join(self.mediaDirectoryPath, mediaId), function(rmError) {
        callback(rmError || error);
      });

    });
  });
};

/**
 * Gets information about medias hosted by TLS.
 *
 * @param {Array} mediasIds The TLS ids of the medias
 * @param {Array} expectedMediasHeights The expected medias heights in the same order as medias ids. This is not used
 * for TLS provider as TLS doesn't transcode medias
 * @param {module:publish/providers/mediaPlatforms/MediaPlatformProvider~MediaPlatformProvider~getMediaInfoCallback}
 * callback The function to call when it's done
 */
TlsProvider.prototype.getMediasInfo = function(mediasIds, expectedMediasHeights, callback) {
  var self = this;
  var parallel = [];
  var infos = {sources: [], available: true};

  mediasIds.forEach(function(mediaId) {
    parallel.push(function(callback) {

      // Get media information from TLS
      return self.client.get('videos/' + mediaId).then(function(response) {
        if (!response.available) infos.available = false;

        infos.sources.push({
          adaptive: [
            {
              mimeType: 'application/x-mpegURL',
              link: response.link
            }
          ]
        });

        callback();
      }).catch(callback);
    });
  });

  async.parallel(parallel, function(error) {
    if (error) return callback(error);
    callback(null, infos);
  });
};

/**
 * Removes medias from TLS platform.
 *
 * @param {Array} mediaIds TLS media ids to remove
 * @param {callback} callback The function to call when it's done
 */
TlsProvider.prototype.remove = function(mediaIds, callback) {
  var self = this;
  var asyncFunctions = [];

  mediaIds.forEach(function(mediaId) {
    asyncFunctions.push(function(callback) {

      // First send remove instruction to TLS
      self.client.delete('videos/' + mediaId).then(function(reponse) {

        // Secondly remove media from local file system
        openVeoApi.fileSystem.rm(path.join(self.mediaDirectoryPath, mediaId), callback);

      }).catch(callback);

    });
  });

  async.series(asyncFunctions, function(error) {
    callback(error);
  });
};

/**
 * Updates a media resources on the platform.
 *
 * If media has several resources on the platform, the same update will be performed for all resources.
 * Actually only the media title and media custom properties are synchronized with TLS.
 *
 * @param {Object} media The media
 * @param {Array} media.mediaId The list of media resource ids
 * @param {Object} data The datas to update
 * @param {String} [data.title] The media title
 * @param {Object} [data.properties] The media custom properties with id / value pairs, custom properties corresponding
 * to the one in TLS configuration will be updated, others won't
 * @param {Boolean} force true to force the update even if title and properties haven't changed, false otherwise
 * @param {callback} callback The function to call when it's done
 */
TlsProvider.prototype.update = function(media, data, force, callback) {
  if (!data.title &amp;&amp; (!data.properties || !Object.keys(data.properties).length)) return callback();

  var self = this;
  var asyncFunctions = [];
  var properties = {};
  var settings;

  // Get TLS settings
  asyncFunctions.push(function(callback) {
    process.api.getCoreApi().settingProvider.getOne(
      new ResourceFilter().equal('id', 'publish-tls'),
      null,
      function(error, tlsSettings) {
        settings = tlsSettings &amp;&amp; tlsSettings.value &amp;&amp; tlsSettings.value.properties;
        callback(error);
      }
    );
  });

  // Get more information about the custom properties being updated
  asyncFunctions.push(function(callback) {
    if (!data.properties || !settings || !settings.length) return callback();

    var propertyProvider = new PropertyProvider(process.api.getCoreApi().getDatabase());

    propertyProvider.getAll(
      new ResourceFilter().in('id', Object.keys(data.properties)),
      ['id', 'name', 'type'],
      {id: 'desc'},
      function(error, fetchedProperties) {
        if (error) return callback(error);

        // TLS expects the name of the custom property associated to its value
        // Find the name of each custom property being updated
        for (var id in data.properties) {
          for (var j = 0; j &lt; fetchedProperties.length; j++) {
            var fetchedProperty = fetchedProperties[j];

            if (fetchedProperty.id === id) {

              // Property found

              // Only custom properties defined in TLS settings can be updated
              if (settings.indexOf(id) === -1) break;

              var actualValue = media.properties &amp;&amp; media.properties[id];

              // Make sure property value has changed before doing anything (force by passes this verification)
              if (fetchedProperty.type === PropertyProvider.TYPES.LIST &amp;&amp; !force) {
                actualValue = media.properties ? media.properties[id] || [] : [];
                if (openVeoApi.util.intersectArray(data.properties[id], actualValue).length)
                  break;
              } else if (data.properties[id] === actualValue &amp;&amp; !force)
                break;

              // TLS expects dates in their literal forms, not a timestamp
              // Convert values of custom properties of type DATE_TIME into date literals
              if (fetchedProperty.type === PropertyProvider.TYPES.DATE_TIME)
                properties[fetchedProperty.name] = new Date(data.properties[id]);
              else
                properties[fetchedProperty.name] = data.properties[id];

              break;
            }

          }
        }

        callback(error);
      }
    );
  });

  // Update resources on TLS platform
  media.mediaId.forEach(function(mediaId) {
    asyncFunctions.push(function(callback) {
      var modifications = {};
      var callbackHasBeenCalled = false;

      // Make sure that title has changed if defined (force by passes this verification)
      // If neither title nor properties have changed, there is nothing more to do
      if ((!data.title || (data.title === media.title &amp;&amp; !force)) &amp;&amp;
        !Object.keys(properties).length) {
        return callback();
      }

      if (data.title) modifications.title = data.title;
      Object.assign(modifications, properties);

      self.client.patch('videos/' + mediaId, modifications).then(function() {
        if (!callbackHasBeenCalled) (callbackHasBeenCalled = true) &amp;&amp; callback();
      }).catch(function(error) {
        if (!callbackHasBeenCalled)
          (callbackHasBeenCalled = true) &amp;&amp; callback(error);
        else throw error;
      });
    });
  });

  async.series(asyncFunctions, function(error) {
    callback(error);
  });
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-publish_controllers_ConfigurationController.html">publish/controllers/ConfigurationController</a></li><li><a href="module-publish_controllers_httpErrors.html">publish/controllers/httpErrors</a></li><li><a href="module-publish_controllers_PropertyController.html">publish/controllers/PropertyController</a></li><li><a href="module-publish_controllers_StatisticsController.html">publish/controllers/StatisticsController</a></li><li><a href="module-publish_controllers_VideoController.html">publish/controllers/VideoController</a></li><li><a href="module-publish_hooks.html">publish/hooks</a></li><li><a href="module-publish_listener.html">publish/listener</a></li><li><a href="module-publish_packages_ArchiveFormat.html">publish/packages/ArchiveFormat</a></li><li><a href="module-publish_packages_archiveFormatFactory.html">publish/packages/archiveFormatFactory</a></li><li><a href="module-publish_packages_ArchiveFormatVersion1.html">publish/packages/ArchiveFormatVersion1</a></li><li><a href="module-publish_packages_ArchiveFormatVersion2.html">publish/packages/ArchiveFormatVersion2</a></li><li><a href="module-publish_packages_ArchivePackage.html">publish/packages/ArchivePackage</a></li><li><a href="module-publish_packages_ArchivePackageError.html">publish/packages/ArchivePackageError</a></li><li><a href="module-publish_packages_errors.html">publish/packages/errors</a></li><li><a href="module-publish_packages_Package.html">publish/packages/Package</a></li><li><a href="module-publish_packages_PackageError.html">publish/packages/PackageError</a></li><li><a href="module-publish_packages_packageFactory.html">publish/packages/packageFactory</a></li><li><a href="module-publish_packages_states.html">publish/packages/states</a></li><li><a href="module-publish_packages_VideoPackageError.html">publish/packages/VideoPackageError</a></li><li><a href="module-publish_providers_mediaPlatforms_factory.html">publish/providers/mediaPlatforms/factory</a></li><li><a href="module-publish_providers_mediaPlatforms_LocalProvider.html">publish/providers/mediaPlatforms/LocalProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_MediaPlatformProvider.html">publish/providers/mediaPlatforms/MediaPlatformProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_tls_TlsClient.html">publish/providers/mediaPlatforms/tls/TlsClient</a></li><li><a href="module-publish_providers_mediaPlatforms_tls_TlsProvider.html">publish/providers/mediaPlatforms/tls/TlsProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_types.html">publish/providers/mediaPlatforms/types</a></li><li><a href="module-publish_providers_mediaPlatforms_VimeoProvider.html">publish/providers/mediaPlatforms/VimeoProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_WowzaProvider.html">publish/providers/mediaPlatforms/WowzaProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_GoogleOAuthHelper.html">publish/providers/mediaPlatforms/youtube/GoogleOAuthHelper</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_YoutubeProvider.html">publish/providers/mediaPlatforms/youtube/YoutubeProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_YoutubeResumableUpload.html">publish/providers/mediaPlatforms/youtube/YoutubeResumableUpload</a></li><li><a href="module-publish_providers_PoiProvider.html">publish/providers/PoiProvider</a></li><li><a href="module-publish_providers_PropertyProvider.html">publish/providers/PropertyProvider</a></li><li><a href="module-publish_providers_VideoPackage.html">publish/providers/VideoPackage</a></li><li><a href="module-publish_providers_VideoProvider.html">publish/providers/VideoProvider</a></li><li><a href="module-publish_PublishError.html">publish/PublishError</a></li><li><a href="module-publish_PublishManager.html">publish/PublishManager</a></li><li><a href="module-publish_PublishPlugin.html">publish/PublishPlugin</a></li><li><a href="module-publish_PublishPluginApi.html">publish/PublishPluginApi</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-publish_controllers_httpErrors-HTTP_ERRORS.html">publish/controllers/httpErrors~HTTP_ERRORS</a></li><li><a href="module-publish_hooks-PUBLISH_HOOKS.html">publish/hooks~PUBLISH_HOOKS</a></li><li><a href="module-publish_packages_errors-ERRORS.html">publish/packages/errors~ERRORS</a></li><li><a href="module-publish_packages_states-STATES.html">publish/packages/states~STATES</a></li><li><a href="module-publish_providers_mediaPlatforms_types-TYPES.html">publish/providers/mediaPlatforms/types~TYPES</a></li></ul><h3>Classes</h3><ul><li><a href="module-publish_controllers_ConfigurationController-ConfigurationController.html">publish/controllers/ConfigurationController~ConfigurationController</a></li><li><a href="module-publish_controllers_PropertyController-PropertyController.html">publish/controllers/PropertyController~PropertyController</a></li><li><a href="module-publish_controllers_StatisticsController-StatisticsController.html">publish/controllers/StatisticsController~StatisticsController</a></li><li><a href="module-publish_controllers_VideoController-VideoController.html">publish/controllers/VideoController~VideoController</a></li><li><a href="module-publish_packages_ArchiveFormatVersion1-ArchiveFormatVersion1.html">publish/packages/ArchiveFormatVersion1~ArchiveFormatVersion1</a></li><li><a href="module-publish_packages_ArchiveFormatVersion2-ArchiveFormatVersion2.html">publish/packages/ArchiveFormatVersion2~ArchiveFormatVersion2</a></li><li><a href="module-publish_packages_ArchiveFormat-ArchiveFormat.html">publish/packages/ArchiveFormat~ArchiveFormat</a></li><li><a href="module-publish_packages_ArchivePackageError-ArchivePackageError.html">publish/packages/ArchivePackageError~ArchivePackageError</a></li><li><a href="module-publish_packages_ArchivePackage-ArchivePackage.html">publish/packages/ArchivePackage~ArchivePackage</a></li><li><a href="module-publish_packages_PackageError-PackageError.html">publish/packages/PackageError~PackageError</a></li><li><a href="module-publish_packages_Package-Package.html">publish/packages/Package~Package</a></li><li><a href="module-publish_packages_VideoPackageError-VideoPackageError.html">publish/packages/VideoPackageError~VideoPackageError</a></li><li><a href="module-publish_providers_mediaPlatforms_LocalProvider-LocalProvider.html">publish/providers/mediaPlatforms/LocalProvider~LocalProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_MediaPlatformProvider-MediaPlatformProvider.html">publish/providers/mediaPlatforms/MediaPlatformProvider~MediaPlatformProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_tls_TlsClient-TlsClient.html">publish/providers/mediaPlatforms/tls/TlsClient~TlsClient</a></li><li><a href="module-publish_providers_mediaPlatforms_tls_TlsProvider-TlsProvider.html">publish/providers/mediaPlatforms/tls/TlsProvider~TlsProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_VimeoProvider-VimeoProvider.html">publish/providers/mediaPlatforms/VimeoProvider~VimeoProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_WowzaProvider-WowzaProvider.html">publish/providers/mediaPlatforms/WowzaProvider~WowzaProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_GoogleOAuthHelper-GoogleOAuthHelper.html">publish/providers/mediaPlatforms/youtube/GoogleOAuthHelper~GoogleOAuthHelper</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_YoutubeProvider-YoutubeProvider.html">publish/providers/mediaPlatforms/youtube/YoutubeProvider~YoutubeProvider</a></li><li><a href="module-publish_providers_mediaPlatforms_youtube_YoutubeResumableUpload-ResumableUpload.html">publish/providers/mediaPlatforms/youtube/YoutubeResumableUpload~ResumableUpload</a></li><li><a href="module-publish_providers_PoiProvider-PoiProvider.html">publish/providers/PoiProvider~PoiProvider</a></li><li><a href="module-publish_providers_PropertyProvider-PropertyProvider.html">publish/providers/PropertyProvider~PropertyProvider</a></li><li><a href="module-publish_providers_VideoPackage-VideoPackage.html">publish/providers/VideoPackage~VideoPackage</a></li><li><a href="module-publish_providers_VideoProvider-VideoProvider.html">publish/providers/VideoProvider~VideoProvider</a></li><li><a href="module-publish_PublishError-PublishError.html">publish/PublishError~PublishError</a></li><li><a href="module-publish_PublishManager-PublishManager.html">publish/PublishManager~PublishManager</a></li><li><a href="module-publish_PublishPluginApi-PublishPluginApi.html">publish/PublishPluginApi~PublishPluginApi</a></li><li><a href="module-publish_PublishPlugin-PublishPlugin.html">publish/PublishPlugin~PublishPlugin</a></li></ul><h3>Events</h3><ul><li><a href="module-publish_packages_ArchivePackage-ArchivePackage.html#event:complete">publish/packages/ArchivePackage~ArchivePackage#complete</a></li><li><a href="module-publish_packages_ArchivePackage-ArchivePackage.html#event:error">publish/packages/ArchivePackage~ArchivePackage#error</a></li><li><a href="module-publish_packages_ArchivePackage-ArchivePackage.html#event:stateChanged">publish/packages/ArchivePackage~ArchivePackage#stateChanged</a></li><li><a href="module-publish_packages_Package-Package.html#event:complete">publish/packages/Package~Package#complete</a></li><li><a href="module-publish_packages_Package-Package.html#event:error">publish/packages/Package~Package#error</a></li><li><a href="module-publish_packages_Package-Package.html#event:stateChanged">publish/packages/Package~Package#stateChanged</a></li><li><a href="module-publish_providers_VideoPackage-VideoPackage.html#event:complete">publish/providers/VideoPackage~VideoPackage#complete</a></li><li><a href="module-publish_providers_VideoPackage-VideoPackage.html#event:error">publish/providers/VideoPackage~VideoPackage#error</a></li><li><a href="module-publish_providers_VideoPackage-VideoPackage.html#event:stateChanged">publish/providers/VideoPackage~VideoPackage#stateChanged</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:complete">publish/PublishManager~PublishManager#complete</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:error">publish/PublishManager~PublishManager#error</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:retry">publish/PublishManager~PublishManager#retry</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:stateChanged">publish/PublishManager~PublishManager#stateChanged</a></li><li><a href="module-publish_PublishManager-PublishManager.html#event:upload">publish/PublishManager~PublishManager#upload</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Fri May 27 2022 07:50:38 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
